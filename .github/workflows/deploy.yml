name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: "Î∞∞Ìè¨ ÌôòÍ≤Ω ÏÑ†ÌÉù (staging/production)"
        required: true
        default: production
        type: choice
        options:
          - staging
          - production

# ÏµúÎåÄ Ìïú Î≤àÎßå Ïã§ÌñâÎêòÎèÑÎ°ù ÏÑ§Ï†ïÌï¥ Î≥ëÎ†¨ Ïã§Ìñâ Ï§ëÎ≥µÏùÑ Î∞©ÏßÄÌï©ÎãàÎã§.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment:
      name: ${{ inputs.environment || 'production' }}
      url: ${{ vars.SERVICE_URL }}
    permissions:
      contents: read

    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.2.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          script: |
            cd Reporch
            git pull
            docker compose up --build -d

  notify:
    needs: [deploy]
    runs-on: ubuntu-22.04
    if: always()
    steps:
      - name: Compose Discord payload
        id: payload
        env:
          DEPLOY_RESULT: ${{ needs.deploy.result }}
        run: |
          STATUS=""
          COLOR=""
          if [ "$DEPLOY_RESULT" = "success" ]; then
            STATUS="üéâ **Î∞∞Ìè¨ ÏÑ±Í≥µ**"
            COLOR=3066993
          elif [ "$DEPLOY_RESULT" = "failure" ]; then
            STATUS="‚ùå **Î∞∞Ìè¨ Ïã§Ìå®**"
            COLOR=15158332
          else
            STATUS="‚ö†Ô∏è **Î∞∞Ìè¨ Í≤∞Í≥º: $DEPLOY_RESULT**"
            COLOR=15105570
          fi
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          read -r -d '' JSON << EOF || true
          {
            "username": "GitHub Actions",
            "content": "<@896570484588703744>",
            "embeds": [
              {
                "title": "$STATUS",
                "color": $COLOR,
                "fields": [
                  {"name": "Repository", "value": "${{ github.repository }}", "inline": true},
                  {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                  {"name": "Commit", "value": "[${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})", "inline": false},
                  {"name": "Deploy", "value": "$DEPLOY_RESULT", "inline": true},
                  {"name": "Run", "value": "[Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
                ],
                "timestamp": "$TIMESTAMP"
              }
            ]
          }
          EOF
          {
            echo 'json<<EOF'
            echo "$JSON"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      # secretsÎ•º if Ï°∞Í±¥ÏóêÏÑú ÏßÅÏ†ë ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏúºÎØÄÎ°ú, ENVÏóê Î≥µÏÇ¨
      - name: Export Discord webhook to env
        run: echo "DISCORD_WEBHOOK=${{ secrets.DISCORD_WEBHOOK }}" >> $GITHUB_ENV

      - name: Send Discord notification
        if: ${{ env.DISCORD_WEBHOOK != '' }}
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ env.DISCORD_WEBHOOK }}
          method: "POST"
          customHeaders: '{"Content-Type": "application/json"}'
          data: ${{ steps.payload.outputs.json }}