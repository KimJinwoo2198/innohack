name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  actions: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install flake8 mypy django-stubs
          pip install -r requirements.txt
      - name: Run Flake8
        run: flake8 .
      - name: Run MyPy
        run: |
          # CI í™˜ê²½ì—ì„œ ì „ìš© ì„¤ì • íŒŒì¼ ì‚¬ìš©í•˜ì—¬ íƒ€ìž… ì²´í¬ ì‹¤í–‰
          mypy . --config-file=mypy_ci.ini

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: reporch_test
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U user -d reporch_test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-test.txt
      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U user; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
      - name: Wait for Redis
        run: |
          python -c "
          import socket
          import time
          import sys
          
          def wait_for_redis():
              for i in range(30):
                  try:
                      sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                      sock.settimeout(1)
                      result = sock.connect_ex(('localhost', 6379))
                      sock.close()
                      if result == 0:
                          print('Redis is ready!')
                          return True
                      print(f'Waiting for Redis... (attempt {i+1}/30)')
                      time.sleep(2)
                  except Exception as e:
                      print(f'Error checking Redis: {e}')
                      time.sleep(2)
              return False
          
          if not wait_for_redis():
              print('Redis failed to start')
              sys.exit(1)
          "
      - name: Run Database Migrations
        env:
          DJANGO_SETTINGS_MODULE: Reporch.settings_ci
        run: |
          python manage.py migrate --run-syncdb
      - name: Run Tests
        env:
          DJANGO_SETTINGS_MODULE: Reporch.settings_ci
        run: |
          # Django í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (pytest ëŒ€ì‹ )
          python manage.py test --verbosity=2 --keepdb
          # ë˜ëŠ” pytestë¥¼ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´:
          # pytest --maxfail=1 --disable-warnings -v --tb=short

  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Web Builder Image
        run: |
          docker build -t judge/web-builder:latest -f judge/dockerfiles/web/Dockerfile judge/dockerfiles/web/
          
      - name: Build Main Application Image
        run: |
          docker build -t reporch:latest .
          
      - name: List Built Images
        run: |
          docker images | grep -E "(judge/web-builder|reporch)"
          
      - name: Save Images as Artifacts
        run: |
          docker save judge/web-builder:latest | gzip > web-builder-image.tar.gz
          docker save reporch:latest | gzip > reporch-image.tar.gz
          
      - name: Upload Web Builder Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-builder-image
          path: web-builder-image.tar.gz
          retention-days: 1
          
      - name: Upload Main App Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: reporch-image
          path: reporch-image.tar.gz
          retention-days: 1

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-images
    strategy:
      matrix:
        image: 
          - judge/web-builder:latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Web Builder Image Artifact
        uses: actions/download-artifact@v4
        with:
          name: web-builder-image
          
      - name: Load Docker Image
        run: |
          docker load < web-builder-image.tar.gz
          docker images
      
      - name: Run Trivy Security Scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ matrix.image }}
          scan-type: 'image'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          format: 'table'
          
      - name: Run Trivy Security Scan (JSON for artifacts)
        uses: aquasecurity/trivy-action@0.33.1
        continue-on-error: true
        with:
          image-ref: ${{ matrix.image }}
          scan-type: 'image'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          format: 'json'
          output: 'trivy-results.json'
          
      - name: Upload Security Scan Results as Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: trivy-results.json
          retention-days: 30
          
      - name: Display Security Scan Summary
        if: always()
        run: |
          echo "## ðŸ”’ ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ìŠ¤ìº”ëœ ì´ë¯¸ì§€: ${{ matrix.image }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "trivy-results.json" ]; then
            echo "### ë°œê²¬ëœ ì·¨ì•½ì :" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat trivy-results.json | jq '.Results[]? | select(.Vulnerabilities) | {Target: .Target, Vulnerabilities: (.Vulnerabilities | length)}' 2>/dev/null || echo "JSON íŒŒì‹± ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ ìžì„¸í•œ ê²°ê³¼ëŠ” ìœ„ì˜ 'Run Trivy Security Scan' ë‹¨ê³„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-images, security-scan]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Images
        uses: actions/download-artifact@v4
        with:
          name: reporch-image
          
      - name: Load Docker Image
        run: |
          docker load < reporch-image.tar.gz
          
      - name: Configure Kubeconfig
        run: |
          # TODO: ì‹¤ì œ kubeconfig ì„¤ì • ë˜ëŠ” secrets ì‚¬ìš©
          echo "Kubeconfig setup placeholder"
          
      - name: Deploy to Kubernetes
        run: |
          # TODO: ì‹¤ì œ ë°°í¬ ë¡œì§ êµ¬í˜„
          echo "Kubernetes deployment placeholder"
          # kubectl apply -f deploy/k8s/ 